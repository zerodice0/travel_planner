name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*' # v1.0.0, v1.2.3 ë“±
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  deploy-prod:
    name: Deploy to Production (Cloudflare)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. íƒœê·¸ ê²€ì¦ (Semantic Versioning)
      - name: Validate tag
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "Expected format: v1.0.0 (Semantic Versioning)"
            exit 1
          fi
          echo "âœ… Tag validation passed: $TAG_NAME"

      # 3. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 4. pnpm ì„¤ì •
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # 5. ì˜ì¡´ì„± ìºì‹±
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 6. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 7. íƒ€ì… ì²´í¬
      - name: Type check
        run: pnpm typecheck

      # 8. ë¦°íŠ¸
      - name: Lint
        run: pnpm lint

      # 9. í”„ë¡œë•ì…˜ ë¹Œë“œ
      - name: Build for production
        env:
          NODE_ENV: production
        run: pnpm build

      # 10. Cloudflare D1 ë§ˆì´ê·¸ë ˆì´ì…˜ í™•ì¸
      - name: Check D1 migrations
        run: |
          echo "ğŸ“Š Checking D1 migrations status..."
          cd apps/api
          ls -la prisma/migrations/ || echo "No migrations directory found"

      # 11. Wrangler ì„¤ì¹˜ ë° ë°°í¬ (ìš´ì˜ í™˜ê²½)
      - name: Deploy to Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "ğŸš€ Deploying to Cloudflare..."

          # Wrangler ê¸€ë¡œë²Œ ì„¤ì¹˜
          npm install -g wrangler

          # Wrangler ì¸ì¦
          echo "ğŸ” Authenticating with Cloudflare..."
          export CLOUDFLARE_API_TOKEN="$CLOUDFLARE_API_TOKEN"

          # D1 ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© (ìš´ì˜ DB)
          echo "ğŸ“¦ Applying D1 migrations..."
          cd apps/api
          wrangler d1 migrations apply travel-planner-prod --remote || echo "âš ï¸  Migration skipped or failed"

          # Cloudflare Pages ë°°í¬ (ì›¹ ì•±)
          echo "ğŸŒ Deploying web app to Cloudflare Pages..."
          cd ../web
          npx wrangler pages deploy dist --project-name=travel-planner-web-prod

          echo "âœ… Deployment to Cloudflare completed!"

      # 12. Health Check (ìš´ì˜ í™˜ê²½)
      - name: Health check (Production)
        env:
          PROD_API_URL: ${{ secrets.PROD_API_URL }}
        run: |
          echo "ğŸ¥ Performing production health check..."

          # ìµœëŒ€ 10ë²ˆ ì¬ì‹œë„ (30ì´ˆ ê°„ê²©)
          for i in {1..10}; do
            echo "Health check attempt $i/10..."

            response=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_API_URL/api/health" || echo "000")

            if [ "$response" = "200" ]; then
              echo "âœ… Production health check passed!"

              # Health ì •ë³´ ì¶œë ¥
              curl -s "$PROD_API_URL/api/health" | jq '.'

              exit 0
            fi

            echo "âš ï¸  Health check failed (HTTP $response). Retrying in 30s..."
            sleep 30
          done

          echo "âŒ Production health check failed after 10 attempts"
          exit 1

      # 13. GitHub Release ìƒì„±
      - name: Create GitHub Release
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "ğŸ“ Creating GitHub Release..."

          # Release ë…¸íŠ¸ë¥¼ íŒŒì¼ë¡œ ìƒì„± (ë³´ì•ˆ ê°•í™”)
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "$TAG_NAME^" 2>/dev/null || echo "")

          {
            echo "## Changes"
            echo ""
            if [ -n "$PREVIOUS_TAG" ]; then
              git log "$PREVIOUS_TAG..$TAG_NAME" --pretty=format:"- %s (%h)" --no-merges
            else
              echo "Initial release"
            fi
            echo ""
            echo ""
            echo "## Deployment"
            echo "- API: Cloudflare Workers"
            echo "- Web: Cloudflare Pages"
            echo "- Database: Cloudflare D1"
            echo ""
            echo "Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          } > release_notes.md

          # GitHub Release ìƒì„± (íŒŒì¼ì—ì„œ ì½ê¸°)
          gh release create "$TAG_NAME" \
            --title "Release $TAG_NAME" \
            --notes-file release_notes.md \
            --verify-tag

          echo "âœ… GitHub Release created: $TAG_NAME"

      # 14. ë°°í¬ ì„±ê³µ ì•Œë¦¼
      - name: Send success notification
        if: success()
        env:
          TAG_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          RUN_ID: ${{ github.run_id }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
          PROD_API_URL: ${{ secrets.PROD_API_URL }}
          PROD_WEB_URL: ${{ secrets.PROD_WEB_URL }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… [Travel Planner] ìš´ì˜ ì„œë²„ ë°°í¬ ì„±ê³µ"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: Travel Planner CI/CD
          body: |
            ğŸ‰ ìš´ì˜ ì„œë²„ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

            ğŸ“Œ ë°°í¬ ì •ë³´:
            - ë²„ì „: ${{ env.TAG_NAME }}
            - ì»¤ë°‹: ${{ env.COMMIT_SHA }}
            - ë°°í¬ì: ${{ env.ACTOR }}

            ğŸ”— ë§í¬:
            - API: ${{ env.PROD_API_URL }}
            - Web: ${{ env.PROD_WEB_URL }}
            - Release: ${{ env.REPO_URL }}/releases/tag/${{ env.TAG_NAME }}
            - GitHub Actions: ${{ env.REPO_URL }}/actions/runs/${{ env.RUN_ID }}

            ğŸš€ Cloudflare ë°°í¬ ì™„ë£Œ
            - Workers (API)
            - Pages (Web)
            - D1 (Database)

            ---
            Travel Planner CI/CD System

      # 15. ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Send failure notification
        if: failure()
        env:
          TAG_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          RUN_ID: ${{ github.run_id }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ [Travel Planner] ìš´ì˜ ì„œë²„ ë°°í¬ ì‹¤íŒ¨"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: Travel Planner CI/CD
          body: |
            âš ï¸  ìš´ì˜ ì„œë²„ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

            ğŸ“Œ ë°°í¬ ì •ë³´:
            - ë²„ì „: ${{ env.TAG_NAME }}
            - ì»¤ë°‹: ${{ env.COMMIT_SHA }}
            - ë°°í¬ì: ${{ env.ACTOR }}

            ğŸ”— ë¡œê·¸ í™•ì¸:
            ${{ env.REPO_URL }}/actions/runs/${{ env.RUN_ID }}

            âš ï¸  ì¦‰ì‹œ í™•ì¸ ë° ì¡°ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.

            ---
            Travel Planner CI/CD System
