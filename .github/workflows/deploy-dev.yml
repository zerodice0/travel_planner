name: Deploy to Development Server

on:
  push:
    branches:
      - develop
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  deploy-dev:
    name: Deploy to Development Server (Mini PC)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ì»¤ë°‹ í•´ì‹œ í™•ì¸ìš©)

      # 2. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 3. pnpm ì„¤ì •
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # 4. ì˜ì¡´ì„± ìºì‹±
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 5. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 6. íƒ€ì… ì²´í¬
      - name: Type check
        run: pnpm typecheck

      # 7. ë¦°íŠ¸
      - name: Lint
        run: pnpm lint

      # 8. ë¹Œë“œ í…ŒìŠ¤íŠ¸
      - name: Build test
        run: pnpm build

      # 9. ë¯¸ë‹ˆPC SSH ë°°í¬
      - name: Deploy to Mini PC
        uses: appleboy/ssh-action@v1.0.3
        env:
          PROJECT_PATH: ${{ secrets.DEV_PROJECT_PATH }}
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          port: ${{ secrets.DEV_SSH_PORT || 22 }}
          script_stop: true # ì—ëŸ¬ ì‹œ ì¤‘ì§€
          envs: PROJECT_PATH
          script: |
            echo "ğŸš€ Starting deployment to development server..."

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd "${PROJECT_PATH:-$HOME/travel-planner}"

            # Git pull (develop ë¸Œëœì¹˜)
            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin develop
            git reset --hard origin/develop

            # í™˜ê²½ ì •ë³´ ì¶œë ¥
            echo "ğŸ“Š Deployment info:"
            echo "Commit: $(git rev-parse --short HEAD)"
            echo "Author: $(git log -1 --pretty=format:'%an')"
            echo "Message: $(git log -1 --pretty=format:'%s')"

            # Docker Compose ì¬ì‹œì‘ (ë¹Œë“œ í¬í•¨)
            echo "ğŸ”„ Restarting Docker containers..."
            docker-compose -f docker-compose.dev.yml up -d --build

            # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸° (30ì´ˆ)
            echo "â³ Waiting for containers to start..."
            sleep 30

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "âœ… Container status:"
            docker-compose -f docker-compose.dev.yml ps

            echo "âœ… Deployment completed!"

      # 10. Health Check
      - name: Health check
        env:
          DEV_API_URL: ${{ secrets.DEV_API_URL }}
        run: |
          echo "ğŸ¥ Performing health check..."

          # ìµœëŒ€ 5ë²ˆ ì¬ì‹œë„ (30ì´ˆ ê°„ê²©)
          for i in {1..5}; do
            echo "Health check attempt $i/5..."

            response=$(curl -s -o /dev/null -w "%{http_code}" "$DEV_API_URL/api/health" || echo "000")

            if [ "$response" = "200" ]; then
              echo "âœ… Health check passed!"

              # Health ì •ë³´ ì¶œë ¥
              curl -s "$DEV_API_URL/api/health" | jq '.'

              exit 0
            fi

            echo "âš ï¸  Health check failed (HTTP $response). Retrying in 30s..."
            sleep 30
          done

          echo "âŒ Health check failed after 5 attempts"
          exit 1

      # 11. ë°°í¬ ì„±ê³µ ì•Œë¦¼
      - name: Send success notification
        if: success()
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          RUN_ID: ${{ github.run_id }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
          DEV_API_URL: ${{ secrets.DEV_API_URL }}
          DEV_WEB_URL: ${{ secrets.DEV_WEB_URL }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… [Travel Planner] ê°œë°œ ì„œë²„ ë°°í¬ ì„±ê³µ"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: Travel Planner CI/CD
          body: |
            ê°œë°œ ì„œë²„ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

            ğŸ“Œ ë°°í¬ ì •ë³´:
            - ë¸Œëœì¹˜: ${{ env.BRANCH_NAME }}
            - ì»¤ë°‹: ${{ env.COMMIT_SHA }}
            - ì‘ì„±ì: ${{ env.ACTOR }}
            - ë©”ì‹œì§€: ${{ env.COMMIT_MESSAGE }}

            ğŸ”— ë§í¬:
            - API: ${{ env.DEV_API_URL }}
            - Web: ${{ env.DEV_WEB_URL }}
            - GitHub Actions: ${{ env.REPO_URL }}/actions/runs/${{ env.RUN_ID }}

            ---
            Travel Planner CI/CD System

      # 12. ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Send failure notification
        if: failure()
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          RUN_ID: ${{ github.run_id }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ [Travel Planner] ê°œë°œ ì„œë²„ ë°°í¬ ì‹¤íŒ¨"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: Travel Planner CI/CD
          body: |
            âš ï¸  ê°œë°œ ì„œë²„ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

            ğŸ“Œ ë°°í¬ ì •ë³´:
            - ë¸Œëœì¹˜: ${{ env.BRANCH_NAME }}
            - ì»¤ë°‹: ${{ env.COMMIT_SHA }}
            - ì‘ì„±ì: ${{ env.ACTOR }}
            - ë©”ì‹œì§€: ${{ env.COMMIT_MESSAGE }}

            ğŸ”— ë¡œê·¸ í™•ì¸:
            ${{ env.REPO_URL }}/actions/runs/${{ env.RUN_ID }}

            í™•ì¸ í›„ ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.

            ---
            Travel Planner CI/CD System
