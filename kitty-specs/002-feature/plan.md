# Implementation Plan: 장소 추가 및 장소 데이터 검증
*Path: [kitty-specs/002-feature/plan.md](kitty-specs/002-feature/plan.md)*


**Branch**: `002-feature` | **Date**: 2025-11-04 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from [kitty-specs/002-feature/spec.md](spec.md)

**Note**: This document was generated by the `/spec-kitty.plan` command and contains all planning decisions and technical context.

All planning questions have been answered during the planning interrogation phase. See research.md for detailed decision rationale.

## Summary

**Primary Requirement**: Enable users to manually add places to the travel planner without Google Places API dependency, with comprehensive validation to ensure data quality.

**Technical Approach**:
- **5-Layer Hybrid Validation**: Guard (rate limiting) → Pipe (profanity filter) → Service (duplicate detection, moderation queue)
- **D1-Optimized Duplicate Detection**: Bounding box SQL queries + application-level Haversine/Levenshtein validation
- **Moderation System**: All user-generated places enter review queue, remain visible while pending
- **Phase 1 Complete Implementation**: Backend API, frontend UI, and basic admin moderation page

## Technical Context

**Language/Version**: TypeScript 5.x (Backend: NestJS, Frontend: React)
**Primary Dependencies**:
- Backend: NestJS, Prisma, `geolib@3.3.4`, `fastest-levenshtein@1.0.16`
- Frontend: React, existing map library (Google Maps or Mapbox)
**Storage**: Cloudflare D1 (SQLite-based)
**Testing**: Jest (unit), Playwright (E2E) - Phase 1 focuses on manual testing
**Target Platform**: Cloudflare Workers (backend), Web browser (frontend)
**Project Type**: Web application (monorepo: apps/backend + apps/web)
**Performance Goals**:
- Duplicate detection: <20ms (bounding box + validation)
- Rate limit check: <5ms (indexed query)
- Place creation: <200ms end-to-end
**Constraints**:
- SQLite limitations (no PostGIS)
- Cloudflare Workers execution limits
- Must support Korean + English content
**Scale/Scope**:
- Expected: 10k+ places, 1k+ daily creations at scale
- Phase 1: Backend (5 files), Frontend (3 components), Admin (1 page)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Type Safety First (NON-NEGOTIABLE)
✅ **PASS** - All TypeScript code uses strict mode, no `any` types, explicit function signatures

### Principle II: Zero Lint Warnings
✅ **PASS** - Code follows existing lint rules, no warning suppressions needed

### Principle III: UI/UX Best Practices
✅ **PASS** - Custom components used (no `alert`/`confirm`/`prompt`), Toast notifications for feedback, WCAG 2.1 AA accessibility planned

### Principle IV: File Size and Modularity
✅ **PASS** - Components follow SRP, business logic separated (Guard/Pipe/Service layers), no files expected to exceed 500 lines

### Principle V: Data Architecture Integrity
✅ **PASS** - Prisma migrations used for schema changes, dual-table architecture preserved (Place cache + UserPlace personalization)

### Additional Constitution Requirements
✅ **Pre-Commit**: Will run `pnpm typecheck` and `pnpm lint --max-warnings 0` before commits
✅ **Development Servers**: No server management during implementation, assumes servers running separately
✅ **Error Handling**: Comprehensive try-catch blocks, meaningful user messages via toast notifications

**Constitution Compliance**: ✅ ALL GATES PASSED

**Post-Design Re-check**: No violations introduced during Phase 1 design

## Project Structure

### Documentation (this feature)

```
kitty-specs/[###-feature]/
├── plan.md              # This file (/spec-kitty.plan command output)
├── research.md          # Phase 0 output (/spec-kitty.plan command)
├── data-model.md        # Phase 1 output (/spec-kitty.plan command)
├── quickstart.md        # Phase 1 output (/spec-kitty.plan command)
├── contracts/           # Phase 1 output (/spec-kitty.plan command)
└── tasks.md             # Phase 2 output (/spec-kitty.tasks command - NOT created by /spec-kitty.plan)
```

### Source Code (repository root)

```
apps/
├── backend/                              # NestJS API server
│   ├── src/
│   │   ├── places/
│   │   │   ├── places.controller.ts      # NEW: Place creation endpoints
│   │   │   ├── places.service.ts         # MODIFIED: Add duplicate detection
│   │   │   └── dto/
│   │   │       └── create-place.dto.ts   # MODIFIED: Make externalId optional
│   │   ├── admin/
│   │   │   └── admin.controller.ts       # NEW: Moderation queue endpoints
│   │   └── common/
│   │       ├── guards/
│   │       │   ├── rate-limit.guard.ts   # NEW: Daily creation limits
│   │       │   └── admin.guard.ts        # EXISTING: Admin auth check
│   │       └── pipes/
│   │           └── profanity-filter.pipe.ts  # NEW: Content filtering
│   ├── prisma/
│   │   └── schema.prisma                 # MODIFIED: Place.externalId optional,
│   │                                     #           PlaceModerationQueue added
│   └── tests/
│       ├── unit/
│       │   ├── duplicate-detection.spec.ts   # NEW: Algorithm tests
│       │   └── rate-limit.spec.ts            # NEW: Rate limit tests
│       └── integration/
│           └── place-creation.spec.ts        # NEW: E2E place creation
│
└── web/                                  # React frontend
    ├── src/
    │   ├── pages/
    │   │   ├── MapPage.tsx               # MODIFIED: Add place addition UI
    │   │   └── AdminModerationPage.tsx   # NEW: Admin review interface
    │   ├── components/
    │   │   ├── PlaceFormModal.tsx        # NEW: Place input form
    │   │   ├── DuplicateWarningDialog.tsx   # NEW: Duplicate notification
    │   │   └── QualityGuidelinesPanel.tsx    # NEW: Quality hints
    │   └── hooks/
    │       └── useModerationQueue.ts     # NEW: Admin queue management
    └── tests/
        └── e2e/
            └── place-addition.spec.ts    # NEW: E2E user flows
```

**Structure Decision**: Monorepo with apps/backend (NestJS) and apps/web (React). New files follow existing project conventions. Guard/Pipe/Service layers align with NestJS patterns. Frontend components use existing design system.

## Complexity Tracking

*Fill ONLY if Constitution Check has violations that must be justified*

**No violations** - All constitution principles satisfied.

The hybrid validation approach (Guard/Pipe/Service) adds layers but each serves a distinct purpose aligned with NestJS best practices and project principles. This is architectural necessity, not unnecessary complexity.
