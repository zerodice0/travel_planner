# Work Packages: ìž¥ì†Œ ì¶”ê°€ ë° ìž¥ì†Œ ë°ì´í„° ê²€ì¦

**Inputs**: Design documents from `/kitty-specs/002-feature/`
**Prerequisites**: plan.md (complete), spec.md (user stories), research.md (complete), data-model.md (complete), contracts/places-api.yaml (complete), quickstart.md (complete)

**Tests**: Manual testing only for Phase 1. Automated tests are NOT required unless explicitly requested.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `kitty-specs/002-feature/tasks/planned/` generated by this command. Treat this file as the high-level checklist; deep implementation detail is in the prompt files.

## Path Conventions
- **Backend**: `apps/backend/src/`
- **Frontend**: `apps/web/src/`
- **Database**: `apps/backend/prisma/`
- **Tests**: `apps/backend/tests/`, `apps/web/tests/`

---

## Work Package WP01: Database Schema & Migration (Priority: P0)

**Goal**: Extend database schema to support user-generated places and moderation queue.
**Independent Test**: Migrations apply successfully; Prisma client generates updated types; database schema matches data-model.md specifications.
**Prompt**: `kitty-specs/002-feature/tasks/planned/WP01-database-schema-migration.md`

### Included Subtasks
- [X] T001 Modify Place model: make externalId optional, add spatial index
- [X] T002 Modify UserPlace model: add createdAt index for rate limiting
- [X] T003 Create PlaceModerationQueue model with status, reviewer relations
- [X] T004 Update User model: add moderation relations (creator, reviewer)
- [X] T005 Generate Prisma migration with all schema changes
- [X] T006 Validate migration applies cleanly to D1 database

**Status**: âœ… COMPLETED (2025-11-08)
**Prompt Location**: `kitty-specs/002-feature/tasks/done/WP01-database-schema-migration.md`

### Implementation Notes
- Modify `apps/backend/prisma/schema.prisma`
- Use `npx prisma migrate dev --name add_place_validation_system`
- Test migration rollback: verify reverse migration works
- Ensure indexes are created for performance (spatial_index, rate_limit_index, status/createdAt on queue)

### Parallel Opportunities
- None (single schema file, sequential migration required)

### Dependencies
- None (starting package)

### Risks & Mitigations
- **Risk**: D1 SQLite limitations with spatial indexing
  - **Mitigation**: Composite index on (latitude, longitude) tested; bounding box queries validated in research.md
- **Risk**: Migration fails in production
  - **Mitigation**: Test locally first; have rollback plan; validate with `prisma migrate status`

---

## Work Package WP02: Backend Validation Infrastructure (Priority: P0)

**Goal**: Implement 3-layer validation infrastructure (Guard, Pipe, Service).
**Independent Test**: Rate limit guard blocks after threshold; profanity pipe rejects bad content; duplicate detection returns candidates correctly.
**Prompt**: `kitty-specs/002-feature/tasks/planned/WP02-backend-validation-infrastructure.md`

### Included Subtasks
- [X] T007 [P] Install dependencies: geolib@3.3.4, fastest-levenshtein@1.0.16
- [X] T008 [P] Create ProfanityFilterPipe in `apps/backend/src/common/pipes/profanity-filter.pipe.ts`
- [X] T009 [P] Create RateLimitGuard in `apps/backend/src/common/guards/rate-limit.guard.ts`
- [X] T010 Implement duplicate detection in PlacesService: bounding box + Haversine + Levenshtein
- [X] T011 Add detectDuplicates() private method in PlacesService
- [X] T012 Add utility functions for distance/similarity calculations

**Status**: âœ… COMPLETED (2025-11-08)
**Prompt Location**: `kitty-specs/002-feature/tasks/done/WP02-backend-validation-infrastructure.md`

### Implementation Notes
- Profanity filter: Research library choice (bad-words, profanity-js) - implement placeholder first
- Rate limit: Query UserPlace count where createdAt >= today AND userId = current user
- Duplicate detection: Two-phase (SQL bounding box Â±0.001Â° â†’ app-level 100m + 80% similarity)
- Service layer accesses PrismaService for database queries

### Parallel Opportunities
- T007-T009 can proceed in parallel (independent files)
- T010-T012 must be sequential (T011 depends on T010)

### Dependencies
- Depends on WP01 (requires updated schema and Prisma client)

### Risks & Mitigations
- **Risk**: Profanity filter library doesn't support Korean
  - **Mitigation**: Custom word list fallback; implement basic filter first
- **Risk**: Duplicate detection false positives/negatives
  - **Mitigation**: Tunable threshold (0.8 similarity); admin can override

---

## Work Package WP03: Place Creation API Implementation (Priority: P1)

**Goal**: Implement complete place creation flow with all validation layers.
**Independent Test**: User can create place via API; rate limits enforced; duplicates detected; moderation queue entry created; all validation layers execute correctly.
**Prompt**: `kitty-specs/002-feature/tasks/planned/WP03-place-creation-api-implementation.md`

### Included Subtasks
- [ ] T013 Update CreatePlaceDto: make externalId optional
- [ ] T014 Modify PlacesController: add validation decorators (@UseGuards, @UsePipes)
- [ ] T015 Implement PlacesService.create(): integrate duplicate check, Place creation, UserPlace creation, moderation queue entry
- [ ] T016 Add POST /places endpoint with full validation stack
- [ ] T017 Add POST /places/validate-duplicate endpoint for frontend pre-check
- [ ] T018 Add GET /places/rate-limit-status endpoint for UI feedback
- [ ] T019 Add comprehensive error handling and user-friendly error messages

### Implementation Notes
- Validation order: DTO â†’ RateLimitGuard â†’ ProfanityFilterPipe â†’ Service (duplicate detection)
- Create sequence: Place (if new) â†’ UserPlace â†’ PlaceModerationQueue (status: pending)
- Error responses follow OpenAPI spec in contracts/places-api.yaml
- Return 201 Created with moderationStatus: 'pending' in response

### Parallel Opportunities
- T013-T014 can proceed in parallel
- T016-T018 can proceed in parallel (different endpoints)
- T015, T019 must be sequential (core logic, error handling)

### Dependencies
- Depends on WP02 (requires Guard, Pipe, duplicate detection)

### Risks & Mitigations
- **Risk**: Transaction safety across Place/UserPlace/Queue creation
  - **Mitigation**: Wrap in Prisma transaction; handle partial failures
- **Risk**: Rate limit race conditions (concurrent requests)
  - **Mitigation**: Acceptable for Phase 1; flag for Phase 2 optimization

---

## Work Package WP04: Admin Moderation Backend (Priority: P1)

**Goal**: Implement admin moderation queue API for reviewing user-generated places.
**Independent Test**: Admin can fetch pending places; approve/reject places; queue filters and pagination work correctly.
**Prompt**: `kitty-specs/002-feature/tasks/done/WP04-admin-moderation-backend.md`

### Included Subtasks
- [X] T020 Create AdminController in `apps/backend/src/admin/admin.controller.ts`
- [X] T021 Implement GET /admin/moderation with status/page/limit query params
- [X] T022 Implement PATCH /admin/moderation/:id for approve/reject actions
- [X] T023 Add AdminGuard to protect moderation endpoints (isAdmin check)
- [X] T024 Add error handling for 403 Forbidden, 404 Not Found
- [X] T025 Include Place, User (creator), User (reviewer) relations in responses

**Status**: âœ… COMPLETED (2025-11-08)
**Prompt Location**: `kitty-specs/002-feature/tasks/done/WP04-admin-moderation-backend.md`

### Implementation Notes
- GET endpoint: Filter by status (pending/approved/rejected), paginate, order by createdAt ASC
- PATCH endpoint: Update status, set reviewerId, reviewedAt, optional reviewNotes
- AdminGuard: Check req.user.isAdmin, throw ForbiddenException if false
- Response format follows OpenAPI ModerationQueueItem schema

### Parallel Opportunities
- T020-T023 can proceed in parallel (independent concerns)
- T024-T025 can proceed in parallel

### Dependencies
- Depends on WP01 (requires PlaceModerationQueue schema)

### Risks & Mitigations
- **Risk**: Admin UI shows stale data (no real-time updates)
  - **Mitigation**: Acceptable for Phase 1; manual refresh; consider WebSocket in Phase 2
- **Risk**: Large moderation queue causes performance issues
  - **Mitigation**: Pagination enforced; max 100 items per page; indexed queries

---

## Work Package WP05: Frontend Place Addition UI (Priority: P1)

**Goal**: Implement user-facing place addition flow with map picker, validation feedback, and duplicate warnings.
**Independent Test**: User clicks map, form opens with coords pre-filled; validation errors display; duplicate warning shows; successful creation shows toast + refreshes list.
**Prompt**: `kitty-specs/002-feature/tasks/done/WP05-frontend-place-addition-ui.md`

### Included Subtasks
- [X] T026 [P] Modify MapPage.tsx: add "Add Place" mode with map click handler
- [X] T027 [P] Create PlaceFormModal component with all fields (name, address, category, description, phone, website)
- [X] T028 [P] Create DuplicateWarningDialog component showing similar places
- [X] T029 [P] Create QualityGuidelinesPanel component with tips and examples
- [X] T030 Integrate form submission: validate-duplicate â†’ show warning OR create place
- [X] T031 Add rate limit status indicator in UI (X/5 places used today)
- [X] T032 Add toast notifications for success/error states
- [X] T033 Handle all API error responses (400, 409, 429)

**Status**: âœ… COMPLETED (2025-11-08)
**Prompt Location**: `kitty-specs/002-feature/tasks/done/WP05-frontend-place-addition-ui.md`

### Implementation Notes
- MapPage state: isAddingPlace, selectedCoords, showPlaceForm, duplicateWarning
- Form validation: client-side validation matching backend DTO rules
- Duplicate warning: show list of similar places with distance/similarity scores
- Quality guidelines: inline panel with content guidelines, examples, best practices
- Use existing map library (Google Maps or Mapbox)
- Use existing toast library (react-hot-toast confirmed installed)

### Parallel Opportunities
- T026-T029 can proceed in parallel (independent components)
- T030-T033 must be sequential (integration logic)

### Dependencies
- Depends on WP03 (requires Place API endpoints)

### Risks & Mitigations
- **Risk**: Users don't understand quality guidelines
  - **Mitigation**: Prominent quality panel; clear examples; in-form hints
- **Risk**: Map click accuracy on mobile devices
  - **Mitigation**: Show confirmation marker; allow coord adjustment
- **Risk**: Form UX confusion with duplicate warnings
  - **Mitigation**: Clear dialog with "Add Anyway" / "Cancel" options

---

## Work Package WP06: Admin Moderation Frontend (Priority: P1)

**Goal**: Implement basic admin moderation interface for reviewing places.
**Independent Test**: Admin opens /admin/moderation page; sees pending places; can approve/reject with notes; status filter works; pagination works.
**Prompt**: `kitty-specs/002-feature/tasks/done/WP06-admin-moderation-frontend.md`

### Included Subtasks
- [X] T034 Create AdminModerationPage component in `apps/web/src/pages/AdminModerationPage.tsx`
- [X] T035 Create ModerationQueueCard component displaying place details + creator info
- [X] T036 Implement status filter tabs (Pending, Approved, Rejected)
- [X] T037 Implement pagination controls with page/limit
- [X] T038 Add approve/reject action buttons with confirmation
- [X] T039 Add review notes input for rejection (required)
- [X] T040 Add route guard for admin-only access (redirect if !isAdmin)
- [X] T041 Add loading states, empty states, error states

**Status**: âœ… COMPLETED (2025-11-08)
**Prompt Location**: `kitty-specs/002-feature/tasks/done/WP06-admin-moderation-frontend.md`

### Implementation Notes
- Route: /admin/moderation (add to routing config)
- Fetch: GET /api/admin/moderation?status=pending&page=1&limit=20
- Approve: PATCH /api/admin/moderation/:id { status: 'approved' }
- Reject: PATCH /api/admin/moderation/:id { status: 'rejected', reviewNotes: '...' }
- Use custom ConfirmDialog component (per CLAUDE.md rules - no window.confirm)
- Display: Place name, address, coords, category, creator name/email, creation date

### Parallel Opportunities
- T034-T037 can proceed in parallel (layout, filtering, pagination)
- T038-T041 must be sequential (actions, guards, states)

### Dependencies
- Depends on WP04 (requires Admin API endpoints)

### Risks & Mitigations
- **Risk**: Large queue causes UI slowdown
  - **Mitigation**: Pagination enforced; lazy loading; virtualization in Phase 2
- **Risk**: Admins accidentally approve/reject wrong place
  - **Mitigation**: Confirmation dialog; show full place details; undo in Phase 2

---

## Work Package WP07: Integration & Polish (Priority: P2)

**Goal**: End-to-end testing, error handling hardening, documentation updates.
**Independent Test**: Complete user journey works (add place â†’ see pending status â†’ admin approves â†’ place visible); all error cases handled gracefully; quickstart.md validated.
**Prompt**: `kitty-specs/002-feature/tasks/planned/WP07-integration-polish.md`

### Included Subtasks
- [ ] T042 Manual E2E test: User adds place with all fields populated
- [ ] T043 Manual E2E test: Duplicate detection triggers warning
- [ ] T044 Manual E2E test: Rate limit blocks 6th place creation
- [ ] T045 Manual E2E test: Admin approves/rejects place
- [ ] T046 Manual E2E test: Rejected place can be edited and resubmitted
- [ ] T047 Verify all error messages are user-friendly (no stack traces in production)
- [ ] T048 Validate quickstart.md scenario: place creation in 30 minutes
- [ ] T049 Update API documentation with actual endpoint URLs and examples
- [ ] T050 Code cleanup: remove TODOs, add JSDoc comments, format code
- [ ] T051 Run lint and typecheck: `pnpm lint --max-warnings 0` and `pnpm typecheck`

### Implementation Notes
- Test with real data: Korean place names, English place names, mixed content
- Test edge cases: very long names (100 chars), special characters, emoji
- Test rate limiting: create 5 places as new user, verify 6th blocked
- Test profanity filter: submit place with inappropriate content
- Verify constitution compliance: no window.alert/confirm/prompt used
- Run pre-commit checks: typecheck, lint pass before marking complete

### Parallel Opportunities
- T042-T046 can proceed in parallel (independent test scenarios)
- T047-T051 must be sequential (quality gates)

### Dependencies
- Depends on WP01-WP06 (all features implemented)

### Risks & Mitigations
- **Risk**: Edge cases discovered late
  - **Mitigation**: Comprehensive manual test scenarios; log issues for Phase 2
- **Risk**: Performance issues under load
  - **Mitigation**: Document limitations; plan optimization for Phase 2

---

## Dependency & Execution Summary

**Execution Sequence**:
```
WP01 (Schema)
  â†“
WP02 (Validation Infrastructure)
  â†“
WP03 (Place API) + WP04 (Admin API)  [Parallel]
  â†“
WP05 (Place UI) + WP06 (Admin UI)   [Parallel]
  â†“
WP07 (Integration & Polish)
```

**Parallelization Strategy**:
- WP01-WP02: Sequential (schema â†’ infrastructure)
- WP03-WP04: Can proceed in parallel (independent API domains)
- WP05-WP06: Can proceed in parallel (independent UI pages)
- WP07: Sequential (depends on all previous)

**MVP Scope (Minimum Viable Product)**: ðŸŽ¯
- WP01: Database Schema (required)
- WP02: Validation Infrastructure (required)
- WP03: Place Creation API (required)
- WP05: Place Addition UI (required)
- **Optional for MVP**: WP04 + WP06 (Admin moderation can be deferred)
- **Recommended MVP**: All WP01-WP06 for complete validation demonstration

**Estimated Effort**:
- WP01: 1-2 hours (schema changes, migration)
- WP02: 3-4 hours (validation layers, duplicate detection)
- WP03: 3-4 hours (API endpoints, service logic)
- WP04: 2-3 hours (admin API)
- WP05: 4-5 hours (place addition UI, map integration)
- WP06: 3-4 hours (admin moderation UI)
- WP07: 2-3 hours (testing, polish)
- **Total: 18-25 hours** (~3-4 days for single developer)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? | Files |
|------------|---------|--------------|----------|-----------|-------|
| T001 | Modify Place model | WP01 | P0 | No | schema.prisma |
| T002 | Modify UserPlace model | WP01 | P0 | No | schema.prisma |
| T003 | Create PlaceModerationQueue | WP01 | P0 | No | schema.prisma |
| T004 | Update User model | WP01 | P0 | No | schema.prisma |
| T005 | Generate migration | WP01 | P0 | No | prisma migrate |
| T006 | Validate migration | WP01 | P0 | No | database |
| T007 | Install dependencies | WP02 | P0 | Yes | package.json |
| T008 | Create ProfanityFilterPipe | WP02 | P0 | Yes | profanity-filter.pipe.ts |
| T009 | Create RateLimitGuard | WP02 | P0 | Yes | rate-limit.guard.ts |
| T010 | Implement duplicate detection | WP02 | P0 | No | places.service.ts |
| T011 | Add detectDuplicates method | WP02 | P0 | No | places.service.ts |
| T012 | Add utility functions | WP02 | P0 | No | places.service.ts |
| T013 | Update CreatePlaceDto | WP03 | P1 | Yes | create-place.dto.ts |
| T014 | Modify PlacesController | WP03 | P1 | Yes | places.controller.ts |
| T015 | Implement PlacesService.create | WP03 | P1 | No | places.service.ts |
| T016 | Add POST /places | WP03 | P1 | Yes | places.controller.ts |
| T017 | Add POST /places/validate-duplicate | WP03 | P1 | Yes | places.controller.ts |
| T018 | Add GET /places/rate-limit-status | WP03 | P1 | Yes | places.controller.ts |
| T019 | Add error handling | WP03 | P1 | No | places.controller.ts |
| T020 | Create AdminController | WP04 | P1 | Yes | admin.controller.ts |
| T021 | Implement GET /admin/moderation | WP04 | P1 | Yes | admin.controller.ts |
| T022 | Implement PATCH /admin/moderation/:id | WP04 | P1 | Yes | admin.controller.ts |
| T023 | Add AdminGuard | WP04 | P1 | Yes | admin.guard.ts |
| T024 | Add error handling | WP04 | P1 | Yes | admin.controller.ts |
| T025 | Include relations | WP04 | P1 | Yes | admin.controller.ts |
| T026 | Modify MapPage | WP05 | P1 | Yes | MapPage.tsx |
| T027 | Create PlaceFormModal | WP05 | P1 | Yes | PlaceFormModal.tsx |
| T028 | Create DuplicateWarningDialog | WP05 | P1 | Yes | DuplicateWarningDialog.tsx |
| T029 | Create QualityGuidelinesPanel | WP05 | P1 | Yes | QualityGuidelinesPanel.tsx |
| T030 | Integrate form submission | WP05 | P1 | No | MapPage.tsx |
| T031 | Add rate limit indicator | WP05 | P1 | No | MapPage.tsx |
| T032 | Add toast notifications | WP05 | P1 | No | MapPage.tsx |
| T033 | Handle API errors | WP05 | P1 | No | MapPage.tsx |
| T034 | Create AdminModerationPage | WP06 | P1 | Yes | AdminModerationPage.tsx |
| T035 | Create ModerationQueueCard | WP06 | P1 | Yes | ModerationQueueCard.tsx |
| T036 | Implement status filters | WP06 | P1 | Yes | AdminModerationPage.tsx |
| T037 | Implement pagination | WP06 | P1 | Yes | AdminModerationPage.tsx |
| T038 | Add approve/reject buttons | WP06 | P1 | No | ModerationQueueCard.tsx |
| T039 | Add review notes input | WP06 | P1 | No | ModerationQueueCard.tsx |
| T040 | Add route guard | WP06 | P1 | No | routing config |
| T041 | Add loading/empty/error states | WP06 | P1 | No | AdminModerationPage.tsx |
| T042 | E2E: Add place with all fields | WP07 | P2 | Yes | Manual test |
| T043 | E2E: Duplicate detection | WP07 | P2 | Yes | Manual test |
| T044 | E2E: Rate limit | WP07 | P2 | Yes | Manual test |
| T045 | E2E: Admin approve/reject | WP07 | P2 | Yes | Manual test |
| T046 | E2E: Rejected place resubmission | WP07 | P2 | Yes | Manual test |
| T047 | Verify error messages | WP07 | P2 | No | All files |
| T048 | Validate quickstart.md | WP07 | P2 | No | Documentation |
| T049 | Update API docs | WP07 | P2 | Yes | contracts/places-api.yaml |
| T050 | Code cleanup | WP07 | P2 | Yes | All files |
| T051 | Run lint and typecheck | WP07 | P2 | No | CI/pre-commit |

---

**Task Breakdown Version**: 1.0
**Generated**: 2025-11-04
**Total Work Packages**: 7
**Total Subtasks**: 51
**Estimated Duration**: 18-25 hours (3-4 developer-days)

> This task breakdown provides comprehensive coverage of the user-generated place validation system. Each work package is independently deliverable with clear acceptance criteria. Prompt files in `kitty-specs/002-feature/tasks/planned/` contain detailed implementation guidance for each work package.
